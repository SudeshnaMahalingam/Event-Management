{% extends 'app_base.html' %}

{% block title %}Reports - Event Scheduler{% endblock %}
{% block header_title %}Utilization Report{% endblock %}

{% block content %}
<div class="row">
    <!-- Filter Panel -->
    <div class="col-12 mb-4">
        <div class="dashboard-card">
            <div class="card-body p-4">
                <form method="GET" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="start_date" class="form-label fw-bold">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date"
                            value="{{ start_date }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="end_date" class="form-label fw-bold">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}"
                            required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-2"></i> Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if report_data %}
    <!-- Chart Visualization -->
    <div class="col-lg-12 mb-4">
        <div class="dashboard-card">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4">Utilization Overview</h5>
                <div style="height: 300px;">
                    <canvas id="reportChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="col-lg-12">
        <div class="dashboard-card">
            <div class="card-body p-0">
                <div class="p-4 border-bottom">
                    <h5 class="fw-bold m-0">Detailed Breakdown</h5>
                    <small class="text-muted">{{ start_date }} to {{ end_date }}</small>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 border-0">Resource Name</th>
                                <th class="border-0">Total Hours</th>
                                <th class="border-0">Bookings Count</th>
                                <th class="border-0 pe-4 text-end">Utilization Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in report_data %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.resource }}</td>
                                <td>{{ item.hours }} hrs</td>
                                <td>
                                    <span class="badge bg-light text-dark border">{{ item.bookings }}</span>
                                </td>
                                <td class="pe-4 text-end">
                                    <div class="d-flex align-items-center justify-content-end">
                                        <div class="progress w-50 me-2" style="height: 6px;">
                                            <div class="progress-bar bg-success" role="progressbar"
                                                style="width: {{ (item.bookings * 10) }}%"></div>
                                        </div>
                                        <small class="text-muted fw-bold">{{ (item.bookings * 10) }}%</small>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('reportChart').getContext('2d');
            const data = {
                labels: [{% for item in report_data %}"{{ item.resource }}", {% endfor %}],
            datasets: [{
                label: 'Total Hours',
                data: [{% for item in report_data %}{{ item.hours }}, {% endfor %}],
            backgroundColor: 'rgba(106, 17, 203, 0.5)',
            borderColor: '#6a11cb',
            borderWidth: 1,
            borderRadius: 5
                }]
            };

        new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        });
    </script>

    {% elif start_date %}
    <div class="col-12">
        <div class="text-center py-5">
            <div class="mb-3 text-muted opacity-50">
                <i class="fas fa-search fa-4x"></i>
            </div>
            <h5>No data found</h5>
            <p class="text-muted">Try adjusting your date range.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}